---
title: "Scrit Data Analysis ADHD month of Birth"
author: "Gosling CJ, Pinabiaux C, Caparos S, Delorme R & Cortese S"
date: "20/02/2021"
output: html_document
---
# Part A. Install packages required to the data analysis

## Install the packages

```{r}
install.packages("readxl", dependencies = TRUE)
install.packages("dplyr", dependencies = TRUE)
install.packages("mice", dependencies = TRUE)
install.packages("Hmisc", dependencies = TRUE)
install.packages("robustbase", dependencies = TRUE)
install.packages("haven", dependencies = TRUE)
```

# Part B. Load and vizualise your dataset

## B.I Load your dataset. 

Run one of the three code provided below depending on the format in which your dataset is stored.
When you run the code, an explorator window should open. If you don't see the window, simply reduce R and your other pages (the window has open but is behind other files)

### B.I.a. If your dataset is stored in ".txt", run this code
```{r}
df_ADHD <- read.delim(file.choose(), na.strings=c("", "NA"))
```

### B.I.b. If your dataset is stored in ".csv" with "," as separator, run this code
```{r}
df_ADHD <- read.csv(file.choose(), sep=",", na.strings=c("", "NA"))
```

### B.I.c. If your dataset is stored in ".csv" with ";" as separator, run this code
```{r}
df_ADHD <- read.csv(file.choose(), sep=";", na.strings=c("", "NA"))
```

### B.I.d. If your dataset is stored in ".xls", run this code
```{r}
df_ADHD <- readxl::read_excel(file.choose())
```


## B.II Vizualise your dataset. 

**this code will open a new tab in R studio named "df_ADHD". Once you have checked your data, you can come back to the script by click on the tab named "Script - Performing Analysis - MoB ADHD.Rmd"**


```{r}
View(df_ADHD)
```



# Part C.I : Check the columns
```{r}
cols <- c("month", "diagconfirmed",
          "agebaseline", "agefollowup",  "followupduration", 
          "presentationbaseline", "presentationfollowup", 
          "diagbaseline", "diagfollowup", 
          "pharmabaseline", "pharmafollowup", 
          "psychcomorbidity", "iq")


cols[which(!cols %in% colnames(df_ADHD))]
```


# Part C.II : Recode the data
```{r}
df_ADHD_recoded <- df_ADHD[, cols]

# Recoding the month of birth to a numeric variable
df_ADHD_recoded$monthrecoded <- dplyr::recode(df_ADHD_recoded$month,
                            'january' = 1,
                            'february' = 2, 
                            'march' = 3,
                            'april' = 4, 
                            'may' = 5,
                            'june' = 6, 
                            'july' = 7,
                            'august' = 8,
                            'september' = 9,
                            'october' = 10, 
                            'november' = 11,
                            'december' = 12)


# Recoding the ADHD status at follow up to a 0 or 1 variable (to facilitate calculations on the persistence)
df_ADHD_recoded$ADHDdiag <- dplyr::recode(df_ADHD_recoded$diagconfirmed,
                            'confirmed' = 1,
                            'notconfirmed' = 0)

# Setting appropriate type to every variables included in the dataset
df_ADHD_recoded$agebaseline <- as.numeric(as.character(df_ADHD_recoded$agebaseline))
df_ADHD_recoded$agefollowup <- as.numeric(as.character(df_ADHD_recoded$agefollowup))
df_ADHD_recoded$followupduration <- as.numeric(as.character(df_ADHD_recoded$followupduration))
df_ADHD_recoded$monthrecoded <- ordered(df_ADHD_recoded$monthrecoded)
df_ADHD_recoded$ADHDdiag <- factor(df_ADHD_recoded$ADHDdiag)
df_ADHD_recoded$presentationbaseline <- as.character(df_ADHD_recoded$presentationbaseline)
df_ADHD_recoded$presentationfollowup <- as.character(df_ADHD_recoded$presentationfollowup)
df_ADHD_recoded$diagbaseline <- as.character(df_ADHD_recoded$diagbaseline)
df_ADHD_recoded$diagfollowup <- as.character(df_ADHD_recoded$diagfollowup)
df_ADHD_recoded$pharmabaseline <- as.character(df_ADHD_recoded$pharmabaseline)
df_ADHD_recoded$pharmafollowup <- as.character(df_ADHD_recoded$pharmafollowup)
df_ADHD_recoded$psychcomorbidity <- as.character(df_ADHD_recoded$psychcomorbidity)
df_ADHD_recoded$iq <- as.numeric(as.character(df_ADHD_recoded$iq))

# verification of the recondings
Study11_a_clean_recoding_Month <- length(unique(df_ADHD_recoded$month)) == length(unique(df_ADHD_recoded$monthrecoded))

Study11_a_clean_recoding_Diag <- length(unique(df_ADHD_recoded$diagconfirmed)) == length(unique(df_ADHD_recoded$ADHDdiag))
```


# Part C.III : Check the data
```{r}
View(df_ADHD_recoded)
```


# Part D. Perform data analysis
```{r}
# Inclusion criteria
df_ADHD_ITT <- subset(df_ADHD_recoded, 
                         agebaseline >= 6 & agebaseline < 10 &
                         agefollowup >= 10 &
                         followupduration >= 4)

# Filter missing values on IV (Month of birth)  and DV (ADHD status at follow up) for the main analyses
df_ADHD_CCA <- subset(df_ADHD_ITT, !is.na(monthrecoded) & !is.na(ADHDdiag))

# Obtaining descriptive statistics on the datasets (ITT; including participants with missing values; CCA including only participants without missing values on the IV and DV)

# general description of the datasets
Study11_a_df_ITT <- Hmisc::describe(df_ADHD_ITT)
Study11_a_df_CCA <- Hmisc::describe(df_ADHD_CCA)

# Number of participants
Study11_a_N_ITT <- nrow(df_ADHD_ITT)
Study11_a_N_CCA <- nrow(df_ADHD_CCA)

# attrition
## number of participants with a complete DV at baseline 
Study11_a_N_participants_baseline <- nrow(df_ADHD_ITT)
## number of participants with a complete DV at follow up  
Study11_a_N_participants_followup <- length(na.omit(df_ADHD_ITT$ADHDdiag))
## % of attrition
Study11_a_Attrition <- Study11_a_N_participants_followup / Study11_a_N_participants_baseline

# Set the minimum number of participants required to perform analyses
Nmin <- 10

# Primary analysis: linear effect of the month of birth on the ADHD persistence
# the analysis is performed only if more than 10 participants have a non-missing IV (month of birth) and DV (ADHD diagnosis at follow up)
# only the summary of the logistic regression is stored to ensure anonymity

# for convenience, we re-extract the number of participants / description of the dataset but under a new name that will be kept across all analyses
Study11_a_Nprimary <- nrow(df_ADHD_CCA)
Study11_a_df_primary <- Hmisc::describe(df_ADHD_CCA)

ifelse(
    Study11_a_Nprimary >= Nmin,
    Study11_a_LogPrimary <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
      family = "binomial",
      data = df_ADHD_CCA)
      ),
    Study11_a_LogPrimary <- paste0("Number of participants with a complete MoB and ADHD diagnosis at follow up is equal to: ", Study11_a_Nprimary))

# Sensitivity analysis 1 : replication of the primary analysis but on participants with a Follow up duration superior or equal to 10 years
# if the number of participants with such a follow up duration is lower than 10, the analysis is not computed.

df.S1 <- subset(df_ADHD_CCA, followupduration >= 10)

Study11_a_NS1 <- nrow(df.S1)

if (Study11_a_NS1 >= Nmin){
  Study11_a_df_S1 <- Hmisc::describe(df.S1)
} else {
  Study11_a_df_S1 <- NULL
}

ifelse(
    Study11_a_NS1 >= Nmin,
    Study11_a_LogS1 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S1)
      ),
    Study11_a_LogS1 <- paste0("Number of participants with a follow up duration superior to 10 years is equal to: ", Study11_a_NS1))



# Sensitivity analysis 2 : replication of the primary analysis but on participants with an initial ADHD diagnosis performed before the age of 8 and a follow up ADHD diagnosis performed after the age of 16
# if the number of participants with such diagnosis criteriais lower than 10, the analysis is not computed.

df.S2 <- subset(df_ADHD_CCA, agebaseline <= 8 & agefollowup >= 16)

Study11_a_NS2 <- nrow(df.S2)

if (Study11_a_NS2 >= Nmin){
  Study11_a_df_S2 <- Hmisc::describe(df.S2)
} else { 
  Study11_a_df_S2 <- NULL 
}

ifelse(
    Study11_a_NS2 >= Nmin,
    Study11_a_LogS2 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial", 
          data = df.S2)
      ),
    Study11_a_LogS2 <- paste0("Number of participants with an age at baseline inferior to 8 years old and an age at follow up superior to 16 years old is equal to: ", Study11_a_NS2))



# Sensitivity analysis 3 : replication of the primary analysis but on participants with an identical diagnosis procedure at baseline and follow up 
# if the number of participants with such diagnosis criteria  is lower than 10, the analysis is not computed.

# we determine whether each participant has an identical diagnosis procedure at baseline and follow up (0 = identical / != 0 -> different)
df_ADHD_CCA$Diag_diff <- stringi::stri_compare(
    as.character(df_ADHD_CCA$diagbaseline), 
    as.character(df_ADHD_CCA$diagfollowup)
    )

df.S3 <- subset(df_ADHD_CCA, Diag_diff == 0)

Study11_a_NS3 <- nrow(df.S3)

if (Study11_a_NS3 >= Nmin){
  Study11_a_df_S3 <- Hmisc::describe(df.S3)
} else { 
  Study11_a_df_S3 <- NULL 
}

ifelse(
    Study11_a_NS3 >= Nmin,
    Study11_a_LogS3 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family="binomial", 
          data=df.S3)
      ),
    Study11_a_LogS3 <- paste0("Number of participants with an identical diagnosis procedure at baseline and follow up is equal to: ", Study11_a_NS3))



# Sensitivity analysis 4 : replication of the primary analysis but on participants without any psychiatric comorbidity
# if the number of participants without comorbidity is lower than 10, the analysis is not computed.

df.S4 <- subset(df_ADHD_CCA, psychcomorbidity == "none")

Study11_a_NS4 <- nrow(df.S4)

if (Study11_a_NS4 >= Nmin){
  Study11_a_df_S4 <- Hmisc::describe(df.S4)
} else { 
  Study11_a_df_S4 <- NULL 
}

ifelse(
    Study11_a_NS4 >= Nmin,
    Study11_a_LogS4 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S4)
      ),
    Study11_a_LogS4 <- paste0("Number of participants without any psychiatric comorbidity is equal to: ", Study11_a_NS4))


# Sensitivity analysis 5 : Determine whether the study has a low attrition rate (i.e., inferior to 20%).
Study11_a_NS5 <- nrow(df_ADHD_CCA)
Study11_a_df_S5 <- Hmisc::describe(df_ADHD_CCA)

ifelse(
    Study11_a_Attrition >= 0.8 & Study11_a_NS5 >= Nmin,
    Study11_a_LogS5 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df_ADHD_CCA)
      ),
    Study11_a_LogS5 <- paste0("The percentage of attrition is equal to: ", Study11_a_Attrition))


# Sensitivity analysis 6 : replication of the primary analysis but with a robust regression (using the robust estimators described in Cantoni and Ronchetti (2006))
# the analysis is performed only if more than 10 participants have a non-missing IV (month of birth) and DV (ADHD diagnosis at follow up)
Study11_a_NS6 <- nrow(df_ADHD_CCA)
Study11_a_df_S6 <- Hmisc::describe(df_ADHD_CCA)


ifelse(
    Study11_a_NS6 >= Nmin,
    Study11_a_LogS6 <- summary(
      robustbase::glmrob(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
                         family = binomial, 
                         method = "Mqle",
                         data = df_ADHD_CCA)
      ),
    Study11_a_LogS6 <- paste0("Number of participants with a complete MoB and ADHD diagnosis at follow up is equal to: ", Study11_a_Nprimary))


# Sensitivity analysis 7 : replication of the primary analysis but by handling missing values on IV or DV by performing multiple imputation

# obtaining the percentage of missing values for all variables included in the dataset
Study11_a_Miss_agebaseline <- sum(is.na(df_ADHD_ITT$agebaseline)) / length(df_ADHD_ITT$agebaseline)
Study11_a_Miss_agefollowup <- sum(is.na(df_ADHD_ITT$agefollowup)) / length(df_ADHD_ITT$agefollowup)
Study11_a_Miss_followupduration <- sum(is.na(df_ADHD_ITT$followupduration)) / length(df_ADHD_ITT$followupduration)
Study11_a_Miss_monthrecoded <- sum(is.na(df_ADHD_ITT$monthrecoded)) / length(df_ADHD_ITT$monthrecoded)
Study11_a_Miss_ADHDdiag <- sum(is.na(df_ADHD_ITT$ADHDdiag)) / length(df_ADHD_ITT$ADHDdiag)
Study11_a_Miss_presentationbaseline <- sum(is.na(df_ADHD_ITT$presentationbaseline)) / length(df_ADHD_ITT$presentationbaseline)
Study11_a_Miss_presentationfollowup <- sum(is.na(df_ADHD_ITT$presentationfollowup)) / length(df_ADHD_ITT$presentationfollowup)
Study11_a_Miss_diagbaseline <- sum(is.na(df_ADHD_ITT$diagbaseline)) / length(df_ADHD_ITT$diagbaseline)
Study11_a_Miss_diagfollowup <- sum(is.na(df_ADHD_ITT$diagfollowup)) / length(df_ADHD_ITT$diagfollowup)
Study11_a_Miss_psychcomorbidity <- sum(is.na(df_ADHD_ITT$psychcomorbidity)) / length(df_ADHD_ITT$psychcomorbidity)
Study11_a_Miss_iq <- sum(is.na(df_ADHD_ITT$iq)) / length(df_ADHD_ITT$iq)
Study11_a_Miss_pharmabaseline <- sum(is.na(df_ADHD_ITT$pharmabaseline)) / length(df_ADHD_ITT$pharmabaseline)
Study11_a_Miss_pharmafollowup <- sum(is.na(df_ADHD_ITT$pharmafollowup)) / length(df_ADHD_ITT$pharmafollowup)

# preparation of the datasets that will be imputed 

# Dataset 1 : no auxiliary variable 
df.S7.wo.AUX <- dplyr::select(df_ADHD_ITT, monthrecoded, ADHDdiag)

# Dataset 2 : all auxiliary variable 
df.S7.AUX.TOT <- dplyr::select(df_ADHD_ITT, 
                               monthrecoded,
                               ADHDdiag,
                               agebaseline, 
                               agefollowup, 
                               followupduration, 
                               presentationbaseline, 
                               presentationfollowup, 
                               diagbaseline,
                               diagfollowup,
                               pharmabaseline,
                               pharmafollowup,
                               psychcomorbidity,
                               iq)

# Dataset 3 : all auxiliary variable with a low rate of missing values (<= 25%).
# we select all covariables to select them according to their rate of missing values
df_covariate <- dplyr::select(df_ADHD_ITT, 
                              agebaseline, 
                              agefollowup, 
                              followupduration, 
                              presentationbaseline, 
                              presentationfollowup, 
                              diagbaseline,
                              diagfollowup,
                              pharmabaseline,
                              pharmafollowup,
                              psychcomorbidity,
                              iq)

df.S7.AUX.select <- data.frame(
  monthrecoded = df_ADHD_ITT$monthrecoded,
  ADHDdiag = df_ADHD_ITT$ADHDdiag,
  df_covariate[ ,which(colMeans(!is.na(df_covariate)) >= 0.75)])

# imputation of the dataset with no auxiliary variables
df_ADHD_Imput_wo_AUX <- mice::mice(
  df.S7.wo.AUX,
  m = 30, maxit = 30, seed = 4321)			  
  
# imputation of the dataset with all auxiliary variables
df_ADHD_Imput_AUX_TOT <- mice::mice(
  df.S7.AUX.TOT,
  m = 30, maxit = 30, seed = 4321)	
  
# imputation of the dataset with auxiliary variables with a low % of missing values
df_ADHD_Imput_AUX_select <- mice::mice(
  df.S7.AUX.select,
  m = 30, maxit = 30, seed = 4321)	
  
# obtaining information on the imputation process 
Study11_a_Imput_meth_wo_AUX <- df_ADHD_Imput_wo_AUX$method
Study11_a_Imput_pred_wo_AUX <- df_ADHD_Imput_wo_AUX$predictorMatrix

Study11_a_Imput_meth_AUX_TOT <- df_ADHD_Imput_AUX_TOT$method
Study11_a_Imput_pred_AUX_TOT <- df_ADHD_Imput_AUX_TOT$predictorMatrix

Study11_a_Imput_meth_AUX_select <- df_ADHD_Imput_AUX_select$method
Study11_a_Imput_pred_AUX_select <- df_ADHD_Imput_AUX_select$predictorMatrix

# N and description of the first imputed dataset
Study11_a_NS7_wo_AUX <- nrow(mice::complete(df_ADHD_Imput_wo_AUX, 1))
Study11_a_df_S7_wo_AUX <- Hmisc::describe(mice::complete(df_ADHD_Imput_wo_AUX, 1))

Study11_a_NS7_AUX_TOT <- nrow(mice::complete(df_ADHD_Imput_AUX_TOT, 1))
Study11_a_df_S7_AUX_TOT <- Hmisc::describe(mice::complete(df_ADHD_Imput_AUX_TOT, 1))

Study11_a_NS7_AUX_select <- nrow(mice::complete(df_ADHD_Imput_AUX_select, 1))
Study11_a_df_S7_AUX_select <- Hmisc::describe(mice::complete(df_ADHD_Imput_AUX_select, 1))


# performing the primary analysis but on the imputed datasets
Study11_a_LogS7_wo_AUX_split <- with(df_ADHD_Imput_wo_AUX,
                                  glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
                                      family = "binomial"))

Study11_a_LogS7_AUX_TOT_split <- with(df_ADHD_Imput_AUX_TOT,
                                   glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
                                       family = "binomial"))

Study11_a_LogS7_AUX_select_split <- with(df_ADHD_Imput_AUX_select,
                                      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
                                          family = "binomial"))

# pooling the regression results
Study11_a_LogS7_wo_AUX <- mice::pool(Study11_a_LogS7_wo_AUX_split)
 
Study11_a_LogS7_AUX_TOT <- mice::pool(Study11_a_LogS7_AUX_TOT_split)

Study11_a_LogS7_AUX_select <- mice::pool(Study11_a_LogS7_AUX_select_split)



# Sensitivity analysis 8 : replication of the primary analysis but on each ADHD presentation separately

# creation of the datasets including only one presentation type
df.S8.hyperactive <- subset(df_ADHD_CCA, presentationbaseline == "hyperactive")
df.S8.inattentive <- subset(df_ADHD_CCA, presentationbaseline == "inattentive")
df.S8.combined <- subset(df_ADHD_CCA, presentationbaseline == "combined")

Study11_a_NS8_hyperactive <- nrow(df.S8.hyperactive)
Study11_a_NS8_inattentive <- nrow(df.S8.inattentive)
Study11_a_NS8_combined <- nrow(df.S8.combined)

if (Study11_a_NS8_hyperactive >= Nmin){
  Study11_a_df_S8_hyperactive <- Hmisc::describe(df.S8.hyperactive)
} else { 
  Study11_a_df_S8_hyperactive <- NULL 
}
if (Study11_a_NS8_inattentive >= Nmin){
  Study11_a_df_S8_inattentive <- Hmisc::describe(df.S8.inattentive)
} else { 
  Study11_a_df_S8_inattentive <- NULL 
}
if (Study11_a_NS8_combined >= Nmin){
  Study11_a_df_S8_combined <- Hmisc::describe(df.S8.combined)
} else { 
  Study11_a_df_S8_combined <- NULL 
}

ifelse(
    Study11_a_NS8_hyperactive >= Nmin,
    Study11_a_LogS8_hyperactive <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S8.hyperactive)
      ),
    Study11_a_LogS8_hyperactive <- paste0("Number of participants with an hyperactive presentation is equal to: ", Study11_a_NS8_hyperactive))

ifelse(
    Study11_a_NS8_inattentive >= Nmin,
    Study11_a_LogS8_inattentive <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S8.inattentive)
      ),
    Study11_a_LogS8_inattentive <- paste0("Number of participants with an inattentive presentation is equal to: ", Study11_a_NS8_inattentive))

ifelse(
    Study11_a_NS8_combined >= Nmin,
    Study11_a_LogS8_combined <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S8.combined)
      ),
    Study11_a_LogS8_combined <- paste0("Number of participants with a combined presentation is equal to: ", Study11_a_NS8_combined))

# Sensitivity analysis 9 : replication of the primary analysis but splitting the sample according to the IQ 
df.S9.iq.below.med <- subset(df_ADHD_CCA, iq < 100)
df.S9.iq.above.med <- subset(df_ADHD_CCA, iq >= 100)

df.S9.iq.cat1<- subset(df_ADHD_CCA, iq < 70)
df.S9.iq.cat2<- subset(df_ADHD_CCA, iq >= 70 & iq < 85)
df.S9.iq.cat3<- subset(df_ADHD_CCA, iq >= 85 & iq < 100)
df.S9.iq.cat4<- subset(df_ADHD_CCA, iq >= 100 & iq < 115)
df.S9.iq.cat5<- subset(df_ADHD_CCA, iq >= 115 & iq < 130)
df.S9.iq.cat6<- subset(df_ADHD_CCA, iq >= 130)

df.S9.iq.di <- subset(df_ADHD_CCA, iq <= 70)
df.S9.iq.moy<- subset(df_ADHD_CCA, iq > 70 & iq < 130)
df.S9.iq.hp <- subset(df_ADHD_CCA, iq >= 130)

Study11_a_NS9_iq_below_med <- nrow(df.S9.iq.below.med)
Study11_a_NS9_iq_above_med <- nrow(df.S9.iq.above.med)

Study11_a_NS9_iq_cat1 <- nrow(df.S9.iq.cat1)
Study11_a_NS9_iq_cat2 <- nrow(df.S9.iq.cat2)
Study11_a_NS9_iq_cat3 <- nrow(df.S9.iq.cat3)
Study11_a_NS9_iq_cat4 <- nrow(df.S9.iq.cat4)
Study11_a_NS9_iq_cat5 <- nrow(df.S9.iq.cat5)
Study11_a_NS9_iq_cat6 <- nrow(df.S9.iq.cat6)

Study11_a_NS9_iq_di <- nrow(df.S9.iq.di)
Study11_a_NS9_iq_moy <- nrow(df.S9.iq.moy)
Study11_a_NS9_iq_hp <- nrow(df.S9.iq.hp)


if (Study11_a_NS9_iq_below_med >= Nmin){
  Study11_a_df_S9_iq_below_med <- Hmisc::describe(df.S9.iq.below.med)
} else { 
  Study11_a_df_S9_iq_below_med <- NULL 
}
if (Study11_a_NS9_iq_above_med >= Nmin){
  Study11_a_df_S9_iq_above_med <- Hmisc::describe(df.S9.iq.above.med)
} else { 
  Study11_a_df_S9_iq_above_med <- NULL 
}

if (Study11_a_NS9_iq_cat1 >= Nmin){
  Study11_a_df_S9_iq_cat1 <- Hmisc::describe(df.S9.iq.cat1)
} else { 
  Study11_a_df_S9_iq_cat1 <- NULL 
}
if (Study11_a_NS9_iq_cat2 >= Nmin){
  Study11_a_df_S9_iq_cat2 <- Hmisc::describe(df.S9.iq.cat2)
} else { 
  Study11_a_df_S9_iq_cat2 <- NULL 
}
if (Study11_a_NS9_iq_cat3 >= Nmin){
  Study11_a_df_S9_iq_cat3 <- Hmisc::describe(df.S9.iq.cat3)
} else { 
  Study11_a_df_S9_iq_cat3 <- NULL 
}
if (Study11_a_NS9_iq_cat4 >= Nmin){
  Study11_a_df_S9_iq_cat4 <- Hmisc::describe(df.S9.iq.cat4)
} else { 
  Study11_a_df_S9_iq_cat4 <- NULL 
}
if (Study11_a_NS9_iq_cat5 >= Nmin){
  Study11_a_df_S9_iq_cat5 <- Hmisc::describe(df.S9.iq.cat5)
} else { 
  Study11_a_df_S9_iq_cat5 <- NULL 
}
if (Study11_a_NS9_iq_cat6 >= Nmin){
  Study11_a_df_S9_iq_cat6 <- Hmisc::describe(df.S9.iq.cat6)
} else { 
  Study11_a_df_S9_iq_cat6 <- NULL 
}


if (Study11_a_NS9_iq_di >= Nmin){
  Study11_a_df_S9_iq_di <- Hmisc::describe(df.S9.iq.di)
} else { 
  Study11_a_df_S9_iq_di <- NULL 
}
if (Study11_a_NS9_iq_moy >= Nmin){
  Study11_a_df_S9_iq_moy <- Hmisc::describe(df.S9.iq.moy)
} else { 
  Study11_a_df_S9_iq_moy <- NULL 
}
if (Study11_a_NS9_iq_hp >= Nmin){
  Study11_a_df_S9_iq_hp <- Hmisc::describe(df.S9.iq.hp)
} else { 
  Study11_a_df_S9_iq_hp <- NULL 
}

ifelse(
    Study11_a_NS9_iq_below_med >= Nmin,
    Study11_a_LogS9_iq_below_med <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.below.med)
      ),
    Study11_a_LogS9_iq_below_med <- paste0("Number of participants with an IQ below 100 is equal to: ", Study11_a_NS9_iq_below_med))

ifelse(
    Study11_a_NS9_iq_above_med >= Nmin,
    Study11_a_LogS9_iq_above_med <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.above.med)
      ),
    Study11_a_LogS9_iq_above_med <- paste0("Number of participants with an IQ above 100 is equal to: ", Study11_a_NS9_iq_above_med))

ifelse(
    Study11_a_NS9_iq_cat1 >= Nmin,
    Study11_a_LogS9_iq_cat1 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.cat1)
      ),
    Study11_a_LogS9_iq_cat1 <- paste0("Number of participants with an IQ below 70 is equal to: ", Study11_a_NS9_iq_cat1))

ifelse(
    Study11_a_NS9_iq_cat2 >= Nmin,
    Study11_a_LogS9_iq_cat2 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.cat2)
      ),
    Study11_a_LogS9_iq_cat2 <- paste0("Number of participants with an IQ ranging from 70 to 85 is equal to: ", Study11_a_NS9_iq_cat2))

ifelse(
    Study11_a_NS9_iq_cat3 >= Nmin,
    Study11_a_LogS9_iq_cat3 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.cat3)
      ),
    Study11_a_LogS9_iq_cat3 <- paste0("Number of participants with an IQ ranging from 85 to 100 is equal to: ", Study11_a_NS9_iq_cat3))

ifelse(
    Study11_a_NS9_iq_cat4 >= Nmin,
    Study11_a_LogS9_iq_cat4 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.cat4)
      ),
    Study11_a_LogS9_iq_cat4 <- paste0("Number of participants with an IQ ranging from 100 to 115 is equal to: ", Study11_a_NS9_iq_cat4))

ifelse(
    Study11_a_NS9_iq_cat5 >= Nmin,
    Study11_a_LogS9_iq_cat5 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.cat5)
      ),
    Study11_a_LogS9_iq_cat5 <- paste0("Number of participants with an IQ ranging from 115 to 130 is equal to: ", Study11_a_NS9_iq_cat5))

ifelse(
    Study11_a_NS9_iq_cat6 >= Nmin,
    Study11_a_LogS9_iq_cat6 <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.cat6)
      ),
    Study11_a_LogS9_iq_cat6 <- paste0("Number of participants with an IQ superior to 130 is equal to: ", Study11_a_NS9_iq_cat6))

ifelse(
    Study11_a_NS9_iq_di >= Nmin,
    Study11_a_LogS9_iq_di <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.di)
      ),
    Study11_a_LogS9_iq_di <- paste0("Number of participants with an IQ below or equal to 70 is equal to: ", Study11_a_NS9_iq_di))

ifelse(
    Study11_a_NS9_iq_moy >= Nmin,
    Study11_a_LogS9_iq_moy <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.moy)
      ),
    Study11_a_LogS9_iq_moy <- paste0("Number of participants with an IQ ranging from 70 to 130 is equal to: ", Study11_a_NS9_iq_moy))

ifelse(
    Study11_a_NS9_iq_hp >= Nmin,
    Study11_a_LogS9_iq_hp <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S9.iq.hp)
      ),
    Study11_a_LogS9_iq_hp <- paste0("Number of participants with an IQ superior or equal to 130 is equal to: ", Study11_a_NS9_iq_hp))

# Sensitivity analysis 10 : replication of the primary analysis but on participants with different treatment configuration

# creation of the datasets 
df.S10.pharma.P.P <- subset(df_ADHD_CCA, 
                            pharmabaseline != "none" &
                              pharmafollowup != "none")

df.S10.pharma.P.A <- subset(df_ADHD_CCA, 
                            pharmabaseline != "none" &
                              pharmafollowup == "none")

df.S10.pharma.A.P <- subset(df_ADHD_CCA, 
                            pharmabaseline == "none" &
                              pharmafollowup != "none")

df.S10.pharma.A.A <- subset(df_ADHD_CCA, 
                            pharmabaseline == "none" &
                              pharmafollowup == "none")

df.S10.pharma.P <- subset(df_ADHD_CCA, 
                              pharmafollowup != "none")

df.S10.pharma.A <- subset(df_ADHD_CCA, 
                              pharmafollowup == "none")

Study11_a_NS10_pharma_P_P <- nrow(df.S10.pharma.P.P)
Study11_a_NS10_pharma_P_A <- nrow(df.S10.pharma.P.A)
Study11_a_NS10_pharma_A_P <- nrow(df.S10.pharma.A.P)
Study11_a_NS10_pharma_A_A <- nrow(df.S10.pharma.A.A)
Study11_a_NS10_pharma_P <- nrow(df.S10.pharma.P)
Study11_a_NS10_pharma_A <- nrow(df.S10.pharma.A)

if (Study11_a_NS10_pharma_P_P >= Nmin){
  Study11_a_df_S10_pharma_P_P <- Hmisc::describe(df.S10.pharma.P.P)
} else { 
  Study11_a_df_S10_pharma_P_P <- NULL 
}
if (Study11_a_NS10_pharma_P_A >= Nmin){
  Study11_a_df_S10_pharma_P_A <- Hmisc::describe(df.S10.pharma.P.A)
} else { 
  Study11_a_df_S10_pharma_P_A <- NULL 
}
if (Study11_a_NS10_pharma_A_P >= Nmin){
  Study11_a_df_S10_pharma_A_P <- Hmisc::describe(df.S10.pharma.A.P)
} else { 
  Study11_a_df_S10_pharma_A_P <- NULL 
}
if (Study11_a_NS10_pharma_A_A >= Nmin){
  Study11_a_df_S10_pharma_A_A <- Hmisc::describe(df.S10.pharma.A.A)
} else { 
  Study11_a_df_S10_pharma_A_A <- NULL 
}
if (Study11_a_NS10_pharma_P >= Nmin){
  Study11_a_df_S10_pharma_P <- Hmisc::describe(df.S10.pharma.P)
} else { 
  Study11_a_df_S10_pharma_P <- NULL 
}
if (Study11_a_NS10_pharma_A >= Nmin){
  Study11_a_df_S10_pharma_A <- Hmisc::describe(df.S10.pharma.A)
} else { 
  Study11_a_df_S10_pharma_A <- NULL 
}
ifelse(
    Study11_a_NS10_pharma_P_P >= Nmin,
    Study11_a_LogS10_pharma_P_P <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S10.pharma.P.P)
      ),
    Study11_a_LogS10_pharma_P_P <- paste0("Number of participants taking medication at baseline and follow up is equal to: ", Study11_a_NS10_pharma_P_P))

ifelse(
    Study11_a_NS10_pharma_P_A >= Nmin,
    Study11_a_LogS10_pharma_P_A <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S10.pharma.P.A)
      ),
    Study11_a_LogS10_pharma_P_A <- paste0("Number of participants taking medication at baseline and not at follow up is equal to: ", Study11_a_NS10_pharma_P_A))

ifelse(
    Study11_a_NS10_pharma_A_P >= Nmin,
    Study11_a_LogS10_pharma_A_P <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S10.pharma.A.P)
      ),
    Study11_a_LogS10_pharma_A_P <- paste0("Number of participants not taking medication at baseline and but taking at follow up is equal to: ", Study11_a_NS10_pharma_A_P))

ifelse(
    Study11_a_NS10_pharma_A_A >= Nmin,
    Study11_a_LogS10_pharma_A_A <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S10.pharma.A.A)
      ),
    Study11_a_LogS10_pharma_A_A <- paste0("Number of participants not taking medication at baseline and follow up is equal to: ", Study11_a_NS10_pharma_A_A))

ifelse(
    Study11_a_NS10_pharma_P >= Nmin,
    Study11_a_LogS10_pharma_P <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S10.pharma.P)
      ),
    Study11_a_LogS10_pharma_P <- paste0("Number of participants taking medication at followup is equal to: ", Study11_a_NS10_pharma_P))

ifelse(
    Study11_a_NS10_pharma_A >= Nmin,
    Study11_a_LogS10_pharma_A <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S10.pharma.A)
      ),
    Study11_a_LogS10_pharma_A <- paste0("Number of participants not taking medication at follow up is equal to: ", Study11_a_NS10_pharma_A))


df_ADHD_wo_baseline <- subset(df_ADHD_recoded, 
                              agebaseline < 10 &
                                agefollowup >= 10 &
                                followupduration >= 4)

Study11_a_df_ADHD_wo_baseline_S11_tot <- Hmisc::describe(df_ADHD_wo_baseline)

df.S11.wo.baseline <- subset(df_ADHD_wo_baseline,
                             !is.na(monthrecoded) & !is.na(ADHDdiag))

Study11_a_df_ADHD_wo_baseline_S11 <- Hmisc::describe(df.S11.wo.baseline)

Study11_a_NS11_wo_baseline <- nrow(df.S11.wo.baseline)


ifelse(
    Study11_a_NS11_wo_baseline >= Nmin,
    Study11_a_LogS11_wo_baseline <- summary(
      glm(ADHDdiag ~ as.numeric(as.character(monthrecoded)), 
          family = "binomial",
          data = df.S11.wo.baseline)
      ),
    Study11_a_LogS11_wo_baseline <- paste0("Number of participants meeting inclusion criteria at follow: ", Study11_a_NS11_wo_baseline))

##############################################################

if (class(Study11_a_LogPrimary) == "summary.glm") {
  Study11_a_LogPrimary$deviance.resid <- NA
}
if (class(Study11_a_LogS1) == "summary.glm") {
  Study11_a_LogS1$deviance.resid <- NA
}
if (class(Study11_a_LogS2) == "summary.glm") {
  Study11_a_LogS2$deviance.resid <- NA
}
if (class(Study11_a_LogS3) == "summary.glm") {
  Study11_a_LogS3$deviance.resid <- NA
}
if (class(Study11_a_LogS4) == "summary.glm") {
  Study11_a_LogS4$deviance.resid <- NA
}
if (class(Study11_a_LogS5) == "summary.glm") {
  Study11_a_LogS5$deviance.resid <- NA
}
if (class(Study11_a_LogS6) == "summary.glmrob") {
  Study11_a_LogS6$residuals <- NA
  Study11_a_LogS6$fitted.values <- NA
}
if (class(Study11_a_LogS8_hyperactive) == "summary.glm") {
  Study11_a_LogS8_hyperactive$deviance.resid <- NA
}
if (class(Study11_a_LogS8_inattentive) == "summary.glm") {
  Study11_a_LogS8_inattentive$deviance.resid <- NA
}
if (class(Study11_a_LogS8_combined) == "summary.glm") {
  Study11_a_LogS8_combined$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_below_med) == "summary.glm") {
  Study11_a_LogS9_iq_below_med$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_above_med) == "summary.glm") {
  Study11_a_LogS9_iq_above_med$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_cat1) == "summary.glm") {
  Study11_a_LogS9_iq_cat1$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_cat2) == "summary.glm") {
  Study11_a_LogS9_iq_cat2$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_cat3) == "summary.glm") {
  Study11_a_LogS9_iq_cat3$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_cat4) == "summary.glm") {
  Study11_a_LogS9_iq_cat4$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_cat5) == "summary.glm") {
  Study11_a_LogS9_iq_cat5$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_cat6) == "summary.glm") {
  Study11_a_LogS9_iq_cat6$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_di) == "summary.glm") {
  Study11_a_LogS9_iq_di$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_moy) == "summary.glm") {
  Study11_a_LogS9_iq_moy$deviance.resid <- NA
}
if (class(Study11_a_LogS9_iq_hp) == "summary.glm") {
  Study11_a_LogS9_iq_hp$deviance.resid <- NA
}
if (class(Study11_a_LogS10_pharma_P_P) == "summary.glm") {
  Study11_a_LogS10_pharma_P_P$deviance.resid <- NA
}
if (class(Study11_a_LogS10_pharma_P_A) == "summary.glm") {
  Study11_a_LogS10_pharma_P_A$deviance.resid <- NA
}
if (class(Study11_a_LogS10_pharma_A_P) == "summary.glm") {
  Study11_a_LogS10_pharma_A_P$deviance.resid <- NA
}
if (class(Study11_a_LogS10_pharma_A_A) == "summary.glm") {
  Study11_a_LogS10_pharma_A_A$deviance.resid <- NA
}
if (class(Study11_a_LogS10_pharma_A) == "summary.glm") {
  Study11_a_LogS10_pharma_A$deviance.resid <- NA
}
if (class(Study11_a_LogS10_pharma_P) == "summary.glm") {
  Study11_a_LogS10_pharma_P$deviance.resid <- NA
}
if (class(Study11_a_LogS11_wo_baseline) == "summary.glm") {
  Study11_a_LogS11_wo_baseline$deviance.resid <- NA
}
  
  
save(
  #verification of the recoding process
  Study11_a_clean_recoding_Month,
  Study11_a_clean_recoding_Diag,
#description of the datasets 
  Study11_a_df_ITT,
  Study11_a_df_CCA,
  Study11_a_df_primary,
  Study11_a_df_ADHD_wo_baseline_S11_tot,
  Study11_a_df_ADHD_wo_baseline_S11,
  Study11_a_df_S1,
  Study11_a_df_S2,
  Study11_a_df_S3,
  Study11_a_df_S4,
  Study11_a_df_S5,
  Study11_a_df_S6,
  Study11_a_df_S7_wo_AUX,
  Study11_a_df_S7_AUX_TOT,
  Study11_a_df_S7_AUX_select,
  Study11_a_df_S8_hyperactive,
  Study11_a_df_S8_inattentive,
  Study11_a_df_S8_combined,
  Study11_a_df_S9_iq_below_med,
  Study11_a_df_S9_iq_above_med,
  Study11_a_df_S9_iq_cat1,
  Study11_a_df_S9_iq_cat2,
  Study11_a_df_S9_iq_cat3,
  Study11_a_df_S9_iq_cat4,
  Study11_a_df_S9_iq_cat5,
  Study11_a_df_S9_iq_cat6,
  Study11_a_df_S9_iq_di,
  Study11_a_df_S9_iq_moy,
  Study11_a_df_S9_iq_hp,
  Study11_a_df_S10_pharma_P_P,
  Study11_a_df_S10_pharma_P_A,
  Study11_a_df_S10_pharma_A_P,
  Study11_a_df_S10_pharma_A_A,
  Study11_a_df_S10_pharma_P,
  Study11_a_df_S10_pharma_A,
# number of participants
  Study11_a_N_ITT, 
  Study11_a_N_CCA,
  Study11_a_Nprimary,
  Study11_a_NS1,
  Study11_a_NS2,
  Study11_a_NS3,
  Study11_a_NS4,
  Study11_a_NS5,
  Study11_a_NS6,
  Study11_a_NS7_wo_AUX,
  Study11_a_NS7_AUX_TOT,
  Study11_a_NS7_AUX_select,
  Study11_a_NS8_hyperactive,
  Study11_a_NS8_inattentive,
  Study11_a_NS8_combined,
  Study11_a_NS9_iq_below_med,
  Study11_a_NS9_iq_above_med,
  Study11_a_NS9_iq_cat1,
  Study11_a_NS9_iq_cat2,
  Study11_a_NS9_iq_cat3,
  Study11_a_NS9_iq_cat4,
  Study11_a_NS9_iq_cat5,
  Study11_a_NS9_iq_cat6,
  Study11_a_NS9_iq_di,
  Study11_a_NS9_iq_moy,
  Study11_a_NS9_iq_hp,
  Study11_a_NS10_pharma_P_P,
  Study11_a_NS10_pharma_P_A,
  Study11_a_NS10_pharma_A_P,
  Study11_a_NS10_pharma_A_A,
  Study11_a_NS10_pharma_P,
  Study11_a_NS10_pharma_A,
  Study11_a_NS11_wo_baseline,
# attrition
  Study11_a_N_participants_baseline, 
  Study11_a_N_participants_followup, 
  Study11_a_Attrition, 
#Results of logistic regressions
  Study11_a_LogPrimary,
  Study11_a_LogS1,
  Study11_a_LogS2,
  Study11_a_LogS3,
  Study11_a_LogS4,
  Study11_a_LogS5,
  Study11_a_LogS6,
  Study11_a_LogS7_wo_AUX,
  Study11_a_LogS7_AUX_TOT,
  Study11_a_LogS7_AUX_select, 
  Study11_a_LogS8_hyperactive,
  Study11_a_LogS8_inattentive,
  Study11_a_LogS8_combined,
  Study11_a_LogS9_iq_below_med,
  Study11_a_LogS9_iq_above_med,
  Study11_a_LogS9_iq_cat1,
  Study11_a_LogS9_iq_cat2,
  Study11_a_LogS9_iq_cat3,
  Study11_a_LogS9_iq_cat4,
  Study11_a_LogS9_iq_cat5,
  Study11_a_LogS9_iq_cat6,
  Study11_a_LogS9_iq_di,
  Study11_a_LogS9_iq_moy,
  Study11_a_LogS9_iq_hp,
  Study11_a_LogS10_pharma_P_P,
  Study11_a_LogS10_pharma_P_A,
  Study11_a_LogS10_pharma_A_P,
  Study11_a_LogS10_pharma_A_A,
  Study11_a_LogS10_pharma_A,
  Study11_a_LogS10_pharma_P,
  Study11_a_LogS11_wo_baseline,
#Percentages of missing values 
  Study11_a_Miss_agebaseline,
  Study11_a_Miss_agefollowup,
  Study11_a_Miss_followupduration,
  Study11_a_Miss_monthrecoded,
  Study11_a_Miss_ADHDdiag,
  Study11_a_Miss_presentationbaseline,
  Study11_a_Miss_presentationfollowup,
  Study11_a_Miss_diagbaseline,
  Study11_a_Miss_diagfollowup,
  Study11_a_Miss_pharmabaseline,
  Study11_a_Miss_pharmafollowup,
  Study11_a_Miss_psychcomorbidity,
  Study11_a_Miss_iq,
#Information on the imputation process
  Study11_a_Imput_meth_wo_AUX,
  Study11_a_Imput_pred_wo_AUX,
  Study11_a_Imput_meth_AUX_TOT, 
  Study11_a_Imput_pred_AUX_TOT,
  Study11_a_Imput_meth_AUX_select, 
  Study11_a_Imput_pred_AUX_select, 
file = "ADHD_Study11_a_res.RData")
Location <- getwd()
paste0("The file has been generated at the following location on your computer: ", "'",Location,"/ADHD_Study11_a_res.RData", "'")
```

# Vizualize results
```{r}
library(ggplot2)
df.plot1 <- dplyr::group_by(df_ADHD_CCA, monthrecoded)
df.plot <- dplyr::summarise(df.plot1, ADHDpersistence = mean(as.numeric(as.character(ADHDdiag)), na.rm = TRUE))

ggplot(df.plot, aes(x = monthrecoded, y = ADHDpersistence)) + 
  geom_bar(stat = "identity", alpha = 0.6) + 
  theme_bw()
```